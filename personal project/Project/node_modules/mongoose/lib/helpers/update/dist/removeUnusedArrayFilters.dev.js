'use strict';
/**
 * MongoDB throws an error if there's unused array filters. That is, if `options.arrayFilters` defines
 * a filter, but none of the `update` keys use it. This should be enough to filter out all unused array
 * filters.
 */

module.exports = function removeUnusedArrayFilters(update, arrayFilters) {
  var updateKeys = Object.keys(update).map(function (key) {
    return Object.keys(update[key]);
  }).reduce(function (cur, arr) {
    return cur.concat(arr);
  }, []);
  return arrayFilters.filter(function (obj) {
    return _checkSingleFilterKey(obj, updateKeys);
  });
};

function _checkSingleFilterKey(arrayFilter, updateKeys) {
  var firstKey = Object.keys(arrayFilter)[0];

  if (firstKey === '$and' || firstKey === '$or') {
    if (!Array.isArray(arrayFilter[firstKey])) {
      return false;
    }

    return arrayFilter[firstKey].find(function (filter) {
      return _checkSingleFilterKey(filter, updateKeys);
    }) != null;
  }

  var firstDot = firstKey.indexOf('.');
  var arrayFilterKey = firstDot === -1 ? firstKey : firstKey.slice(0, firstDot);
  return updateKeys.find(function (key) {
    return key.includes('$[' + arrayFilterKey + ']');
  }) != null;
}